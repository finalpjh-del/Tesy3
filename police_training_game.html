<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>경찰 양성 게임 - 전투</title>
<style>
:root{--bg1:#ff9966;--bg2:#ff5e62;--ink:#10131a;--paper:#fff}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;background:linear-gradient(90deg,var(--bg1),var(--bg2));color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;text-align:center}
.bar{display:flex;align-items:center;justify-content:space-between;padding:8px 10px}
.pill{background:#0b1020;color:#fff;border-radius:999px;padding:8px 12px;font-weight:700;text-decoration:none;box-shadow:0 0 0 2px #1e88e520}
.ok{background:linear-gradient(90deg,#ff9966,#ff5e62);color:#fff;font-weight:800;border:0;border-radius:14px;padding:12px 16px;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.25)}
.ok:disabled{opacity:.5;cursor:not-allowed}
.hud{margin:4px 0 6px}
#pDice,#eDice{font-size:92px;display:inline-block}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:14px;z-index:1000}
.modal{width:min(92vw,680px);background:var(--paper);color:var(--ink);border-radius:18px;padding:20px;box-shadow:0 18px 50px rgba(0,0,0,.35)}
.group .pill{margin:4px} .pill.active{outline:3px solid #ff9966}
.btnrow{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;max-width:760px;margin:8px auto;padding:0 10px}
.afterrow{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;max-width:900px;margin:8px auto;padding:0 10px}
@media (max-width:700px){ .btnrow,.afterrow{grid-template-columns:repeat(2,1fr);} }
.small{font-size:13px;opacity:.95}
#toast{position:fixed;top:14px;left:50%;transform:translateX(-50%);z-index:1300;display:none}
#toast .bubble{background:rgba(255,255,255,.95);color:#111;padding:10px 14px;border-radius:999px;box-shadow:0 6px 22px rgba(0,0,0,.35);font-weight:800}
#diss{position:fixed;inset:0;pointer-events:none;background:#fff;opacity:0;transition:opacity 3s;z-index:1200}
</style>
</head>
<body>
<h1 style="margin:10px 0 6px">🎲 경찰 양성 🎲 <span class="small" style="opacity:.8">v0.26</span></h1>

<!-- 신원 선택 -->
<div id="start" class="overlay" style="display:flex">
  <div class="modal">
    <div style="font-weight:800">🪪 신원 선택</div>
    <div class="small" style="margin:6px 0">선택하지 않은 항목은 무작위로 정해집니다.</div>

    <div class="group"><div style="margin-top:8px">조직</div>
      <button class="pill selOrg" data-val="police">🚓 경찰</button>
      <button class="pill selOrg" data-val="coast">🚤 해양경찰</button>
    </div>
    <div class="group"><div style="margin-top:8px">성별</div>
      <button class="pill selGen" data-val="M">👨 남자</button>
      <button class="pill selGen" data-val="F">👩 여자</button>
    </div>
    <div class="group"><div style="margin-top:8px">시작 계급</div>
      <button class="pill selRank" data-val="0">의경</button>
      <button class="pill selRank" data-val="1">순경</button>
    </div>

    <div style="margin-top:8px"><label for="nm">이름</label>
      <input id="nm" type="text" placeholder="비워두면 자동 이름" style="padding:10px 12px;border:1px solid #ddd;border-radius:12px;width:100%;max-width:280px"></div>

    <div style="display:flex;justify-content:flex-end;margin-top:10px"><button id="btnStart" class="ok">시작</button></div>
  </div>
</div>

<!-- 상단 바 -->
<div class="bar">
  <a class="pill" href="index.html?v=0.26">⬅️ 메인</a>
  <span id="orgBadge" class="pill">🚓 경찰</span>
  <button id="btnResign" class="pill">📝 의원면직</button>
</div>

<!-- HUD -->
<div class="hud">
  <span id="emoji">👮</span> <span id="rank">순경</span> <span id="name">—</span>
  | ❤️ <span id="hp">50</span>/<span id="maxhp">50</span>
  | 💰 <span id="gold">0</span>
  | 💉 <span id="bags">0</span>
  | 🔫 <span id="weapon">무기없음</span>
</div>

<!-- 적 정보 -->
<div>⚔️ 적: <span id="enemyName"></span> (체력: <span id="enemyHP"></span>)</div>

<!-- 전투 버튼 -->
<div class="btnrow">
  <button id="btnRoll" class="ok">🎲 굴리기</button>
  <button id="btnBaton" class="ok">🦯 삼단봉 (1💰)</button>
  <button id="btnFire" class="ok">🔫 격발</button>
  <button id="btnSwitchWeapon" class="pill">🔄 무기변환</button>
</div>

<!-- 전투 중 구급함 -->
<div style="margin-top:6px"><button id="btnUseBag" class="ok">💉 ❤️+30 (턴 소요)</button></div>

<!-- 애프터 패널 -->
<div id="after" style="display:none; margin-top:12px">
  <div style="margin-bottom:8px;font-weight:800">✅ 제압 완료!</div>
  <div class="afterrow">
    <button id="btnRest" class="ok">🛀 씻고 출근</button>
    <button id="btnBuyBag" class="ok">💉 구급함 (5💰)</button>
    <button id="btnUseBagAfter" class="ok">💉 사용 (❤️+30)</button>
    <button id="btnPromote" class="ok" title="연차 도달 시 활성화">🎖️ 승진도전 (10💰)</button>
  </div>
  <!-- 무기구입 패널 복구 -->
  <div class="afterrow" style="margin-top:6px">
    <button id="buy22"  class="pill">22lr 권총 (10💰)</button>
    <button id="buy9"   class="pill">9mm 권총 (20💰)</button>
    <button id="buyShot" class="pill">엽총 (35💰)</button>
    <button id="buyTaser" class="pill">테이저건 (50💰)</button>
  </div>
</div>

<!-- 승진 도전 모달 (필요 점수 표기) -->
<div id="promo" class="overlay">
  <div class="modal" style="max-width:680px;text-align:center">
    <div style="font-weight:800">🎖️ 승진도전</div>
    <div class="small" id="promoNeed" style="margin-top:6px">필요 점수: 7 이상</div>
    <div style="margin-top:8px"><span id="pd1" style="font-size:92px">🎲</span> <span id="pd2" style="font-size:92px">🎲</span></div>
    <div id="presult" class="small" style="height:22px;margin-top:6px"></div>
    <div style="display:flex;justify-content:center;margin-top:8px;gap:8px">
      <button id="promoGo" class="ok">🎲 주사위 굴리기</button>
      <button id="promoClose" class="pill" disabled>닫기</button>
    </div>
  </div>
</div>

<!-- 토스트 & 디졸브 -->
<div id="toast"><div class="bubble" id="toastMsg">알림</div></div>
<div id="diss"></div>

<script>
(()=>{
// ====== 공통 ======
const $=id=>document.getElementById(id);
const D=['⚀','⚁','⚂','⚃','⚄','⚅'];
const R=["의경","순경","경장","경사","경위","경감","경정","총경","경무관","치안감","치안정감","치안총감"];
const rint=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;

// ====== 상태 ======
const state={
  org:"police", gender:"M", name:"—",
  rankIdx:1, entryRank:"순경",
  maxHP:50, hp:50, gold:0, bags:0,
  level:1, enemyHP:0, enemyLabel:"",
  monthsAccum:0, rankMonths:Array(R.length).fill(0),
  rolling:false, toasting:false, toastQ:[],
  weapon:null, // '22lr'|'9mm'|'shot'|'taser'|null
  promoLockedUntilNextAnniv:false
};

// ====== 규칙(요건/연차) ======
const reqByRank=i=> i===0?6 : i<=3?7 : i<=6?8 : i<=9?9 : i===10?10 : 12;
const minMonths=i=> i===0?36 : i<=4?12 : i<=6?24 : i<=10?12 : 12; // 의경3y, 순경~경위1y, 경감~경정2y
const monthsInCurrentRank=()=>state.rankMonths[state.rankIdx];

// ====== 토스트(2초 큐) ======
function pushToast(msg){ state.toastQ.push(msg); runToast(); }
function runToast(){
  if(state.toasting || state.toastQ.length===0) return;
  state.toasting=true;
  const m=state.toastQ.shift();
  $("toastMsg").textContent=m; $("toast").style.display="block";
  setTimeout(()=>{ $("toast").style.display="none"; state.toasting=false; runToast(); }, 2000);
}

// ====== 저장(명예·추모관) ======
function saveToMemorial(payload){
  try{
    const key="police_memorials";
    const arr=JSON.parse(localStorage.getItem(key)||"[]");
    payload.id=Date.now();
    arr.push(payload);
    localStorage.setItem(key, JSON.stringify(arr));
  }catch(e){}
}

// ====== 엔딩(순직: 3초 디졸브 후) ======
function showFallenEnding(){
  const d=$("diss"); d.style.opacity=1;
  // 1계급 특진
  const beforeRank = state.rankIdx;
  const afterRank = Math.min(R.length-1, state.rankIdx+1);
  setTimeout(()=>{
    d.style.opacity=0;
    alert(`🕯 순직\n\n${state.name}님은 임무 중 순직했습니다.\n"순직으로 인한 1계급 특진" (${R[beforeRank]} → ${R[afterRank]})`);
    // 추모관 저장
    saveToMemorial({
      name: state.name,
      gender: state.gender,
      org: state.org==='coast'?'해양경찰':'경찰',
      entryRank: state.entryRank,
      currentRank: R[afterRank],
      endTitle: "순직",
      startDate: new Date().toISOString(), // 시작일을 추적했다면 그 값을 사용
      months: state.monthsAccum,
      finalGold: state.gold,
      achievements: [],
      changeLog: [`순직으로 인한 1계급 특진: ${R[beforeRank]} → ${R[afterRank]}`],
      defeated: {}
    });
    // 리셋 또는 메인으로
    location.href="honor_memorial.html?v=0.26";
  },3000);
}

// ====== 신원 선택 ======
const markActive=(cls,el)=>{ document.querySelectorAll('.'+cls).forEach(b=>b.classList.remove('active')); el.classList.add('active'); };
document.querySelectorAll('.selOrg').forEach(b=>b.addEventListener('click',()=>{state.org=b.dataset.val;markActive('selOrg',b);}));
document.querySelectorAll('.selGen').forEach(b=>b.addEventListener('click',()=>{state.gender=b.dataset.val;markActive('selGen',b);}));
document.querySelectorAll('.selRank').forEach(b=>b.addEventListener('click',()=>{state.rankIdx=parseInt(b.dataset.val,10); state.entryRank=R[state.rankIdx]; markActive('selRank',b);}));

$("btnStart").onclick=()=>{
  if(!document.querySelector('.selOrg.active')){ state.org=(rint(0,1)?'police':'coast'); }
  if(!document.querySelector('.selGen.active')){ state.gender=(rint(0,1)?'M':'F'); }
  if(!document.querySelector('.selRank.active')){ state.rankIdx=1; state.entryRank=R[1]; }
  state.name = ($("nm").value.trim() || (state.gender==='F'?'민경':'포돌'));
  // 초기화
  state.maxHP=50; state.hp=50; state.gold=0; state.bags=0;
  state.level=1; state.monthsAccum=0; state.rankMonths=Array(R.length).fill(0);
  state.weapon=null;
  $("start").style.display="none";
  spawn(); updateHUD();
};

// ====== 전투/적 ======
function spawn(){ state.enemyLabel=`Lv.${state.level} 용의자`; state.enemyHP=15 + state.level*2; }
function updateHUD(){
  $("rank").textContent=R[state.rankIdx];
  $("name").textContent=state.name;
  $("emoji").textContent=state.gender==='F'?'👮‍♀️':'👮‍♂️';
  $("orgBadge").textContent = state.org==='coast'?'🚤 해양경찰':'🚓 경찰';
  $("hp").textContent=state.hp; $("maxhp").textContent=state.maxHP;
  $("gold").textContent=state.gold; $("bags").textContent=state.bags;
  $("weapon").textContent=state.weapon?state.weapon.toUpperCase():'무기없음';
  $("enemyName").textContent=state.enemyLabel; $("enemyHP").textContent=state.enemyHP;
  const inBattle = state.enemyHP>0 && $("after").style.display!=="block";
  ["btnRoll","btnBaton","btnFire","btnUseBag","btnSwitchWeapon"].forEach(id=>$(id).disabled = !inBattle || state.rolling);
  // 승진 버튼: 연차 & 잠금 & 비용
  const need=reqByRank(state.rankIdx);
  const m=monthsInCurrentRank(); const okYear = m>=minMonths(state.rankIdx) && m%12===0;
  $("btnPromote").disabled = !(okYear && !state.promoLockedUntilNextAnniv && state.gold>=10);
}

// 주사위 애니메이션(0.5s)
function rollDiceAnim(done){
  if(state.rolling) return;
  state.rolling=true; updateHUD();
  let t=0; const iv=setInterval(()=>{
    $("pDice").textContent=D[rint(1,6)-1]; $("eDice").textContent=D[rint(1,6)-1];
    t+=80; if(t>=480){ clearInterval(iv); const p=rint(1,6), e=rint(1,6);
      $("pDice").textContent=D[p-1]; $("eDice").textContent=D[e-1];
      state.rolling=false; done(p,e);
    }
  },80);
}

// 한 턴 종료 후 토스트
function endTurnToasts({bRes,reward}){
  if(bRes) pushToast(`🦯 삼단봉: 주사위 ${bRes.p} ×2 = ${bRes.dmg} 피해`);
  if(reward) pushToast(`🏅 제압 보상: +${reward}💰`);
}

// HP 체크 → 순직 엔딩
function checkDeath(){
  if(state.hp<=0){ showFallenEnding(); return true; }
  return false;
}

// ====== 버튼 ======
$("btnRoll").onclick=()=>{
  if(state.enemyHP<=0 || $("after").style.display==="block") return;
  rollDiceAnim((p,e)=>{
    state.enemyHP=Math.max(0,state.enemyHP-p);
    state.hp=Math.max(0,state.hp-e);
    if(checkDeath()) return;
    if(state.enemyHP<=0){
      const reward = 5 + state.level;
      state.gold += reward;
      endTurnToasts({reward});
      $("after").style.display="block";
      state.level++;
      state.monthsAccum+=4;
      state.rankMonths[state.rankIdx]+=4;
    }
    updateHUD();
  });
};

$("btnBaton").onclick=()=>{
  if(state.enemyHP<=0) return; if(state.gold<1) return;
  state.gold--;
  rollDiceAnim((p,e)=>{
    const dmg=p*2;
    state.enemyHP=Math.max(0, state.enemyHP - dmg);
    state.hp=Math.max(0, state.hp - e);
    if(checkDeath()) return;
    if(state.enemyHP<=0){
      const reward = 5 + state.level;
      state.gold += reward;
      endTurnToasts({bRes:{p,dmg},reward});
      $("after").style.display="block";
      state.level++;
      state.monthsAccum+=4;
      state.rankMonths[state.rankIdx]+=4;
    }else{
      endTurnToasts({bRes:{p,dmg}});
    }
    updateHUD();
  });
};

$("btnUseBag").onclick=()=>{
  if(state.bags<=0 || state.hp===state.maxHP || state.enemyHP<=0) return;
  state.bags--; state.hp=Math.min(state.maxHP, state.hp+30);
  // 턴 소요: 적만 주사위
  rollDiceAnim((_,e)=>{
    state.hp=Math.max(0,state.hp-e);
    if(checkDeath()) return;
    updateHUD();
  });
};

// 격발(간단 버전: 무기별 명중률/데미지/비용)
const WEAPONS = {
  "22lr": {cost:3, hit:0.75, dmg:[20,30]},
  "9mm":  {cost:4, hit:0.70, dmg:[25,40]},
  "shot": {cost:6, hit:0.60, dmg:[40,60]},
  "taser":{cost:10,hit:0.20, special:"kill"} // 20% 즉시 제압
};
$("btnFire").onclick=()=>{
  if(state.enemyHP<=0) return;
  if(!state.weapon){ pushToast("🔫 무기가 없습니다. 애프터에서 구매하세요."); return; }
  const w=WEAPONS[state.weapon];
  if(state.gold<w.cost){ pushToast("💸 골드 부족"); return; }
  state.gold-=w.cost;
  // 턴 공유: 나/적 동시에 주사위 1회
  rollDiceAnim((p,e)=>{
    if(w.special==="kill"){ if(Math.random()<w.hit){ state.enemyHP=0; } }
    else {
      if(Math.random()<w.hit){
        const dmg=rint(w.dmg[0],w.dmg[1]);
        state.enemyHP=Math.max(0,state.enemyHP-dmg);
        pushToast(`🔫 격발 적중! -${dmg}`);
      }else{
        pushToast("🔫 빗나감");
      }
    }
    state.hp=Math.max(0,state.hp-e);
    if(checkDeath()) return;
    if(state.enemyHP<=0){
      const reward = 5 + state.level;
      state.gold += reward;
      endTurnToasts({reward});
      $("after").style.display="block";
      state.level++;
      state.monthsAccum+=4;
      state.rankMonths[state.rankIdx]+=4;
    }
    updateHUD();
  });
};

// 무기 변환(소유 중일 때만 순환)
$("btnSwitchWeapon").onclick=()=>{
  const owned = Object.keys(WEAPONS).filter(k=>state[`own_${k}`]);
  if(owned.length===0){ pushToast("🔄 보유 무기가 없습니다."); return; }
  if(!state.weapon){ state.weapon=owned[0]; }
  else{
    const idx=owned.indexOf(state.weapon);
    state.weapon=owned[(idx+1)%owned.length];
  }
  updateHUD();
};

// 애프터 패널
$("btnRest").onclick=()=>{
  $("after").style.display="none";
  spawn(); updateHUD();
};
$("btnBuyBag").onclick=()=>{ if(state.gold>=5){ state.gold-=5; state.bags++; updateHUD(); } };
$("btnUseBagAfter").onclick=()=>{ if(state.bags>0 && state.hp<state.maxHP){ state.bags--; state.hp=Math.min(state.maxHP,state.hp+30); updateHUD(); } };
// 무기구입 복구
$("buy22").onclick=()=>{ if(state.gold>=10){ state.gold-=10; state.own_22lr=true; state.weapon=state.weapon||'22lr'; updateHUD(); } };
$("buy9").onclick=()=>{ if(state.gold>=20){ state.gold-=20; state.own_9mm=true; state.weapon=state.weapon||'9mm'; updateHUD(); } };
$("buyShot").onclick=()=>{ if(state.gold>=35){ state.gold-=35; state.own_shot=true; state.weapon=state.weapon||'shot'; updateHUD(); } };
$("buyTaser").onclick=()=>{ if(state.gold>=50){ state.gold-=50; state.own_taser=true; state.weapon=state.weapon||'taser'; updateHUD(); } };

// 승진 도전(모달에서 필요점수 표기, 시도 후 이번 연차 비활성화)
$("btnPromote").onclick=()=>{
  const need=reqByRank(state.rankIdx);
  const m=monthsInCurrentRank();
  const okYear = m>=minMonths(state.rankIdx) && m%12===0;
  if(!okYear || state.gold<10 || state.promoLockedUntilNextAnniv) return;
  $("promo").style.display="flex";
  $("promoNeed").textContent=`필요 점수: ${need} 이상`;
  $("presult").textContent=""; $("promoClose").disabled=true; $("promoGo").disabled=false;
  setTimeout(()=>{$("promoClose").disabled=false;},2000);

  $("promoGo").onclick=()=>{
    $("promoGo").disabled=true;
    const a=rint(1,6), b=rint(1,6), sum=a+b;
    $("pd1").textContent=D[a-1]; $("pd2").textContent=D[b-1];
    state.gold-=10;
    if(sum>=need){
      state.rankIdx=Math.min(R.length-1, state.rankIdx+1);
      state.maxHP+=10; state.hp=state.maxHP;
      // 새 계급 근무개월은 0부터
      // 이전 계급 카운터는 그대로(통계용), 현 rankIdx 카운터는 이후 +4개월 때 증가
      pushToast(`✅ 승진 성공! (필요 ${need}, 당신 ${sum})`);
    }else{
      pushToast(`❌ 승진 실패… (필요 ${need}, 당신 ${sum})`);
    }
    state.promoLockedUntilNextAnniv=true;  // 이번 연차 잠금(버튼 비활성화 효과 강화)
    updateHUD();
  };
};
$("promoClose").onclick=()=>{ $("promo").style.display="none"; };

// 의원면직(간단 처리: 엔딩 저장 후 추모관 이동)
$("btnResign").onclick=()=>{
  if(!confirm("의원면직 하시겠습니까?")) return;
  saveToMemorial({
    name: state.name,
    gender: state.gender,
    org: state.org==='coast'?'해양경찰':'경찰',
    entryRank: state.entryRank,
    currentRank: R[state.rankIdx],
    endTitle: "의원면직",
    startDate: new Date().toISOString(),
    months: state.monthsAccum,
    finalGold: state.gold,
    achievements: [],
    changeLog: ["의원면직"],
    defeated: {}
  });
  location.href="honor_memorial.html?v=0.26";
};

// 초기
$("start").style.display="flex";
spawn(); updateHUD();
})();
</script>
</body>
</html>
