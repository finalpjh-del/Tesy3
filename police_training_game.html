<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ê²½ì°° ì–‘ì„± ê²Œì„ - ì „íˆ¬</title>
<style>
  :root{--bg1:#ff9966;--bg2:#ff5e62;--ink:#10131a;--paper:#fff}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:linear-gradient(90deg,var(--bg1),var(--bg2)); color:#fff;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; text-align:center;
    -webkit-user-select:none; user-select:none; -webkit-touch-callout:none; touch-action:manipulation;
  }
  .bar{display:flex;align-items:center;justify-content:space-between;padding:8px 10px}
  .pill{background:#0b1020;color:#fff;border-radius:999px;padding:8px 12px;font-weight:700;text-decoration:none; box-shadow:0 0 0 2px #1e88e520}
  .pill.police{box-shadow:0 0 0 2px #4fc3f7, 0 0 18px #4fc3f766}
  .pill.coast{box-shadow:0 0 0 2px #1565c0, 0 0 18px #0d47a166}
  .ok{background:linear-gradient(90deg,#ff9966,#ff5e62);color:#fff;font-weight:800;border:0;border-radius:14px;padding:12px 16px;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.25)}
  .ok:disabled{opacity:.5;cursor:not-allowed}
  .hud{margin:4px 0 6px}
  #pDice,#eDice,#promoD1,#promoD2{font-size:92px;display:inline-block}
  .shake{animation:shake .3s ease}
  @keyframes shake{0%{transform:translate(-2px,0)}50%{transform:translate(6px,-4px)}100%{transform:translate(0,0)}}
  .promoShake{animation:promoShake .5s ease}
  @keyframes promoShake{
    0%{transform:translate(-2px,0) scale(1) rotate(0deg)}
    25%{transform:translate(8px,-6px) scale(1.3) rotate(20deg)}
    50%{transform:translate(-10px,4px) scale(.9) rotate(-25deg)}
    75%{transform:translate(6px,-8px) scale(1.25) rotate(18deg)}
    100%{transform:translate(0,0) scale(1) rotate(0deg)}
  }
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:14px;z-index:1000}
  .modal{width:min(92vw,640px);background:var(--paper);color:var(--ink);border-radius:18px;padding:20px;box-shadow:0 18px 50px rgba(0,0,0,.35)}
  .titlechip{display:inline-flex;align-items:center;gap:8px;padding:8px 14px;border-radius:12px;color:#fff;background:linear-gradient(90deg,#ff9966,#ff5e62);font-weight:800;box-shadow:0 2px 10px rgba(255,120,90,.4)}
  .seg{display:inline-flex;border:1px solid rgba(0,0,0,.12);border-radius:12px;overflow:hidden}
  .seg button{background:#f3f6fb;color:#111;display:flex;align-items:center;gap:8px;padding:8px 12px;border:0;cursor:pointer}
  .seg button.selected{background:#111;color:#fff;font-weight:800}
  #ending{position:fixed;inset:0;background:rgba(0,0,0,.9);display:none;align-items:center;justify-content:center;color:#fff;z-index:1200}
  #ending .panel{width:min(92vw,780px);max-height:85vh;overflow:auto;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.2);border-radius:18px;padding:22px;text-align:left}
  #ending h2{margin:0 0 10px}
  #ending ul{list-style:none;padding:0;margin:8px 0 10px}
  #ending li{margin:6px 0}
  .sec{display:flex;align-items:center;gap:10px;margin:14px 0 8px}
  .sec .chip{padding:6px 12px;border-radius:999px;background:linear-gradient(90deg,#fff,#ffe4d6);color:#111;font-weight:800}
  .sec .line{height:1px;background:linear-gradient(90deg,rgba(255,255,255,.7),rgba(255,255,255,.1));flex:1}
  .cta{text-align:center;margin-top:10px}
  .small{font-size:13px;opacity:.9}
  #toast{position:fixed;top:14px;left:50%;transform:translateX(-50%);z-index:1300;display:none}
  #toast .bubble{background:rgba(255,255,255,.95);color:#111;padding:10px 14px;border-radius:999px;box-shadow:0 6px 22px rgba(0,0,0,.35);font-weight:800}
  /* ë²„íŠ¼ ê·¸ë¦¬ë“œ */
  .btnrow{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;justify-items:stretch;align-items:stretch;margin:8px auto;max-width:760px;padding:0 10px}
  .btnrow .ok,.btnrow .pill{width:100%}
  .afterrow{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;justify-items:stretch;align-items:stretch;margin:8px auto;max-width:900px;padding:0 10px}
  @media (max-width:700px){ .btnrow,.afterrow{grid-template-columns:repeat(2,minmax(0,1fr));} }
  /* ê²©ë°œ ì„¬ê´‘ */
  #flash{position:fixed;inset:0;pointer-events:none;mix-blend-mode:screen;display:none;z-index:1100}
</style>
</head>
<body>
  <h1 style="margin:10px 0 6px">ğŸ² ê²½ì°° ì–‘ì„± ğŸ² <span class="small" style="opacity:.8">v0.21</span></h1>

  <!-- ì‹ ì› ì„ íƒ -->
  <div id="start" class="overlay" style="display:flex">
    <div class="modal">
      <div class="titlechip">ğŸªª ì‹ ì› ì„ íƒ</div>
      <div class="small" style="margin:6px 0">ì„ íƒí•˜ì§€ ì•Šì€ í•­ëª©ì€ ë¬´ì‘ìœ„ë¡œ ì •í•´ì§‘ë‹ˆë‹¤.</div>

      <div style="margin-top:8px">ì¡°ì§</div>
      <div class="seg" id="grpOrg" role="group">
        <button data-org="police" id="orgPolice">ğŸš“ ê²½ì°°</button>
        <button data-org="coast" id="orgCoast">ğŸš¤ í•´ì–‘ê²½ì°°</button>
      </div>

      <div style="height:10px"></div>
      <div>ì„±ë³„</div>
      <div class="seg" id="grpGender" role="group">
        <button data-g="M" id="genderM">ğŸ‘¨ ë‚¨ì</button>
        <button data-g="F" id="genderF">ğŸ‘© ì—¬ì</button>
      </div>

      <div style="height:10px"></div>
      <div>ì‹œì‘ ê³„ê¸‰</div>
      <div class="seg" id="grpRank" role="group">
        <button data-rank="1" id="rankStartA">ìˆœê²½</button>
        <button data-rank="4" id="rankStartB">ê²½ìœ„</button>
      </div>

      <div style="height:10px"></div>
      <div>
        <label for="nm">ì´ë¦„</label>
        <input id="nm" type="text" placeholder="ë¹„ì›Œë‘ë©´ ê¸°ë³¸ ì´ë¦„ ì ìš©" style="padding:10px 12px;border:1px solid #ddd;border-radius:12px;width:100%;max-width:280px" />
      </div>

      <div style="display:flex;justify-content:flex-end;margin-top:10px">
        <button id="btnStart" class="ok">ì‹œì‘</button>
      </div>
    </div>
  </div>

  <!-- ìƒë‹¨ ë°” -->
  <div class="bar">
    <a class="pill" id="backMain" href="index.html?v=0.21">â¬…ï¸ ë©”ì¸</a>
    <span id="orgBadge" class="pill">ğŸš“ ê²½ì°°</span>
    <button id="btnResign" class="pill" title="30ë…„ ì´ìƒ ê·¼ë¬´ ìƒíƒœì—ì„œ ëˆ„ë¥´ë©´ ì •ë…„í‡´ì§">ğŸ“ ì˜ì›ë©´ì§</button>
  </div>

  <!-- HUD -->
  <div class="hud">
    <span id="emoji">ğŸ‘®</span>
    <span id="rank">ìˆœê²½</span>
    <span id="name">â€”</span>
    | â¤ï¸ <span id="hp">50</span>/<span id="maxhp">50</span>
    | ğŸ’° <span id="gold">0</span>
    | ğŸ’‰ êµ¬ê¸‰í•¨ <span id="bags">0</span>
  </div>

  <!-- ì  ì •ë³´ & í–‰ë™ -->
  <div>
    âš”ï¸ ì : <span id="enemyName"></span> (ì²´ë ¥: <span id="enemyHP"></span>)
  </div>

  <!-- ë²„íŠ¼ ê·¸ë¦¬ë“œ -->
  <div class="btnrow">
    <button id="btnRoll" class="ok">ğŸ² êµ´ë¦¬ê¸°</button>
    <button id="btnBaton" class="ok">ğŸ¦¯ ì‚¼ë‹¨ë´‰ (1ğŸ’°)</button>
    <button id="btnFire" class="ok">ğŸ”« ê²©ë°œ (ë¬´ê¸° ì—†ìŒ)</button>
    <button id="btnSwitchWeapon" class="pill" title="ë³´ìœ  ë¬´ê¸° ìˆœí™˜">ğŸ”„ ë¬´ê¸°ë³€í™˜</button>
  </div>
  <div style="margin:6px 0" class="small" id="msg">âš”ï¸ ì œì•• ì¤‘...</div>
  <div class="flex" style="display:flex;align-items:center;justify-content:center;gap:16px">
    ë‚˜: <span id="pDice">ğŸ²</span> ì : <span id="eDice">ğŸ²</span>
  </div>

  <!-- ì „íˆ¬ ì¤‘ êµ¬ê¸‰í•¨(í„´ ì†Œìš”, ì ë§Œ ë°˜ê²©) -->
  <div style="margin-top:6px">
    <button id="btnUseBag" class="ok">ğŸ’‰ â¤ï¸+30 (í„´ ì†Œìš”)</button>
  </div>

  <!-- ì• í”„í„° íŒ¨ë„ -->
  <div id="after" style="display:none; margin-top:12px">
    <div style="margin-bottom:8px;font-weight:800">âœ… ì œì•• ì™„ë£Œ!</div>
    <div class="afterrow">
      <button id="btnRest" class="ok">ğŸ›€ ì”»ê³  ì¶œê·¼</button>
      <button id="btnBuyBag" class="ok">ğŸ’‰ êµ¬ê¸‰í•¨ (5ğŸ’°)</button>
      <button id="btnUseBagAfter" class="ok">ğŸ’‰ ì‚¬ìš© (â¤ï¸+30)</button>
      <button id="btnPromote" class="ok" title="ì—°ì°¨ ë„ë‹¬ ì‹œ í™œì„±í™”">ğŸ–ï¸ ìŠ¹ì§„ë„ì „ (<span id="cost">10</span>ğŸ’°)</button>
    </div>

    <!-- ë¬´ê¸° ìƒì  -->
    <div style="margin-top:10px">
      <div class="small" style="opacity:.95;font-weight:800;margin-bottom:6px">ğŸ”§ ë¬´ê¸° êµ¬ë§¤(ì˜êµ¬ ì‚¬ìš©)</div>
      <div class="afterrow">
        <button id="buy22" class="pill">22lr ê¶Œì´ (10ğŸ’°)</button>
        <button id="buy9"  class="pill">9mm ê¶Œì´ (20ğŸ’°)</button>
        <button id="buyShot" class="pill">ì—½ì´ (35ğŸ’°)</button>
        <button id="buyTaser" class="pill">í…Œì´ì €ê±´ (50ğŸ’°)</button>
      </div>
    </div>

    <div class="small" id="afterInfo" style="margin-top:10px;opacity:.95"></div>
  </div>

  <!-- ì¼ë°˜ íŒì—… -->
  <div id="pop" class="overlay">
    <div class="modal" style="max-height:85vh;overflow:auto">
      <div id="popTitle" class="titlechip">ì•Œë¦¼</div>
      <ul id="popList" style="list-style:none;padding:0;margin:10px 0"></ul>
      <div style="display:flex;justify-content:flex-end">
        <button id="popOk" class="ok">í™•ì¸</button>
      </div>
    </div>
  </div>

  <!-- ìŠ¹ì§„ ë„ì „ ëª¨ë‹¬ -->
  <div id="promo" class="overlay">
    <div class="modal" style="max-width:680px;text-align:center">
      <div class="titlechip" id="promoTitle">ğŸ–ï¸ ìŠ¹ì§„ë„ì „</div>
      <div class="small" id="promoDesc">ì£¼ì‚¬ìœ„ 2ê°œ í•©ì´ ìš”êµ¬ì¹˜ ì´ìƒì´ë©´ ìŠ¹ì§„</div>
      <div style="margin-top:8px">
        <span id="promoD1">ğŸ²</span>
        <span id="promoD2">ğŸ²</span>
      </div>
      <div style="display:flex;justify-content:center;margin-top:6px;gap:8px">
        <button id="promoGo" class="ok">ğŸ² ì£¼ì‚¬ìœ„ êµ´ë¦¬ê¸°</button>
        <button id="promoCancel" class="pill">ì·¨ì†Œ</button>
      </div>
    </div>
  </div>

  <!-- ì—”ë”© -->
  <div id="ending">
    <div class="panel">
      <h2 id="endTitle">ì—”ë”© â€” <span id="endPlayerName">â€”</span></h2>
      <ul id="endList"></ul>
      <div id="achBlock" class="sec" style="display:none"><span class="chip">ì—…ì </span><span class="line"></span></div>
      <ul id="ach" style="display:none"></ul>
      <div class="sec"><span class="chip">ìŠ¹ì§„/ê°•ë“± ì´ë ¥</span><span class="line"></span></div>
      <ul id="hist"></ul>
      <div class="sec"><span class="chip">ì œì•• ëª©ë¡</span><span class="line"></span></div>
      <ul id="kill"></ul>
      <div class="cta">
        <a id="gotoGallery" href="honor_memorial.html?v=0.21" class="pill" style="text-decoration:none">ëª…ì˜ˆâ€¢ì¶”ëª¨ê´€ ì—´ê¸°</a>
        <button id="backToStart" class="pill">ì‹ ì› ì„ íƒìœ¼ë¡œ</button>
      </div>
    </div>
  </div>

  <!-- í† ìŠ¤íŠ¸ & ì„¬ê´‘ -->
  <div id="toast"><div class="bubble" id="toastMsg">ì•Œë¦¼</div></div>
  <canvas id="flash"></canvas>

<script>
(()=>{
// ---------- ì—˜ë¦¬ë¨¼íŠ¸ & ìƒìˆ˜ ----------
const $ = id => document.getElementById(id);
const RANKS = ["ì˜ê²½","ìˆœê²½","ê²½ì¥","ê²½ì‚¬","ê²½ìœ„","ê²½ê°","ê²½ì •","ì´ê²½","ê²½ë¬´ê´€","ì¹˜ì•ˆê°","ì¹˜ì•ˆì •ê°","ì¹˜ì•ˆì´ê°"];
const DICE = ['âš€','âš','âš‚','âšƒ','âš„','âš…'];
const ENEMIES = {
  1:["ğŸ§Ÿâ€â™‚ï¸ ì£¼ì·¨ì","ğŸ¦¹â€â™‚ï¸ ë³´ì´ìŠ¤í”¼ì‹±"],
  2:["ğŸ¤¹â€â™‚ï¸ ì‚¬ê¸°ê¾¼","ğŸ‘¨â€ğŸ’» ìŠ¤í† ì»¤"],
  3:["ğŸ§Œ ì¡°í­","ğŸ’Š ë§ˆì•½ì‚¬ë²”"],
  4:["ğŸ‘¤ ê°„ì²©","ğŸª– í…ŒëŸ¬ë¦¬ìŠ¤íŠ¸"],
  5:["ğŸ‘¨â€âœˆï¸ ë¶€íŒ¨í•œ ê²½ì°°","ğŸ—£ï¸ ë‚´ë€ ìš°ë‘ë¨¸ë¦¬"],
  6:["ğŸ§Ÿ íŠ¹ìˆ˜ ì¢€ë¹„","ğŸ§Ÿâ€â™‚ï¸ íŠ¹ìˆ˜ ì¢€ë¹„"]
};
const MAX_LEVEL = 99;

const el = {
  start:$("start"), btnStart:$("btnStart"), nm:$("nm"),
  grpOrg:$("grpOrg"), grpGender:$("grpGender"), grpRank:$("grpRank"),
  orgBadge:$("orgBadge"), backMain:$("backMain"), emoji:$("emoji"), rank:$("rank"), name:$("name"),
  hp:$("hp"), maxhp:$("maxhp"), gold:$("gold"), bags:$("bags"),
  enemyName:$("enemyName"), enemyHP:$("enemyHP"), btnRoll:$("btnRoll"), btnFire:$("btnFire"),
  btnBaton:$("btnBaton"), btnSwitchWeapon:$("btnSwitchWeapon"),
  pDice:$("pDice"), eDice:$("eDice"), msg:$("msg"),
  btnUseBag:$("btnUseBag"),
  after:$("after"), btnRest:$("btnRest"), btnBuyBag:$("btnBuyBag"), btnUseBagAfter:$("btnUseBagAfter"),
  btnPromote:$("btnPromote"), cost:$("cost"), afterInfo:$("afterInfo"),
  pop:$("pop"), popTitle:$("popTitle"), popList:$("popList"), popOk:$("popOk"),
  promo:$("promo"), promoD1:$("promoD1"), promoD2:$("promoD2"), promoGo:$("promoGo"), promoCancel:$("promoCancel"),
  ending:$("ending"), endTitle:$("endTitle"), endList:$("endList"), hist:$("hist"), kill:$("kill"), ach:$("ach"),
  achBlock:$("achBlock"), endPlayerName:$("endPlayerName"),
  btnResign:$("btnResign"), backToStart:$("backToStart"),
  toast:$("toast"), toastMsg:$("toastMsg"),
  // ìƒì 
  buy22:$("buy22"), buy9:$("buy9"), buyShot:$("buyShot"), buyTaser:$("buyTaser"),
  flash:$("flash")
};

const state = {
  org:null, gender:null, name:"â€”",
  startRankIdx:1, rankIdx:1, entryRank:"ìˆœê²½",
  level:1, maxHP:50, hp:50, gold:0, bags:0,
  enemyHP:0, enemyLabel:"", cost:10,
  ended:false, startDate:new Date(),
  defeated:{}, changeLog:[],
  monthsAccum:0,
  ammo:'', ownedWeapons: new Set(),
  demotionCount:0,
  lastRankChangeMonths:0, lastPromoAnnivNotifiedAt:-1,
  doubleStreak:0, doubleJustBonus:false,
  lastTier:null,
  // ì—…ì  ì§‘ê³„
  batonUses:0, kitUses:0, specialPostCareer:null,
  // ì´ë²ˆ í„´ ì´ë²¤íŠ¸
  turn:{ fireMsg:null, excessive:null, reward:null }
};

const rint=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const emojiByGender=()=> state.gender==='F'?'ğŸ‘®â€â™€ï¸':(state.gender==='M'?'ğŸ‘®â€â™‚ï¸':'ğŸ‘®');
const orgName=()=> state.org==='coast'?'í•´ì–‘ê²½ì°°':'ê²½ì°°';
const enemyTier=lv =>
  lv<=15?1: lv<=35?2: lv<=57?3: lv<=71?4: lv<=95?5: 6;
const monthsInRank=()=> state.monthsAccum - state.lastRankChangeMonths;
const fmtYM=(months)=>{ const y=Math.floor((months||0)/12), m=(months||0)%12; return m===0 ? `${String(y).padStart(2,'0')}ë…„` : `${String(y).padStart(2,'0')}ë…„ ${String(m).padStart(2,'0')}ê°œì›”`; };
const nthYearLabel=(m)=> `${Math.floor((m||0)/12)}ë…„ì°¨`;

// --------- í† ìŠ¤íŠ¸ í ---------
const toastQ=[];
let toastBusy=false;
function pushToast(msg,ms=2000){ toastQ.push({msg,ms}); runToastQ(); }
function runToastQ(){
  if(toastBusy||!toastQ.length) return;
  toastBusy=true;
  const {msg,ms}=toastQ.shift();
  el.toastMsg.textContent=msg;
  el.toast.style.display='block';
  setTimeout(()=>{ el.toast.style.display='none'; toastBusy=false; runToastQ(); }, ms);
}

// --------- ê²©ë°œ ì„¬ê´‘ ---------
function flashMuzzle(){
  const cvs=el.flash, g=cvs.getContext('2d'); const W=innerWidth, H=innerHeight;
  cvs.width=W; cvs.height=H; cvs.style.display='block';
  const grad=g.createRadialGradient(W*0.6,H*0.6,10, W*0.6,H*0.6, Math.max(W,H)*0.7);
  grad.addColorStop(0,'rgba(255,255,200,0.95)');
  grad.addColorStop(0.25,'rgba(255,255,150,0.6)');
  grad.addColorStop(0.6,'rgba(255,255,255,0.0)');
  g.fillStyle=grad; g.fillRect(0,0,W,H);
  setTimeout(()=>{ cvs.style.display='none'; }, 100); // 0.1ì´ˆ
}

// ---------- ë¬´ê¸°/íƒ„ì¢… ----------
const weaponOrder = ['22lr','9mm','shotgun','taser'];
const weaponName = w => w==='22lr'?'22lr ê¶Œì´': w==='9mm'?'9mm ê¶Œì´': w==='shotgun'?'ì—½ì´(ë²…ìƒ·)': 'í…Œì´ì €ê±´';
function fireStats(){
  if(state.ammo==='9mm') return {type:'9mm', cost:4, hit:0.70, min:25, max:40};
  if(state.ammo==='shotgun') return {type:'shotgun', cost:6, hit:0.60, min:40, max:60};
  if(state.ammo==='taser') return {type:'taser', cost:10, hit:0.20, min:0, max:0};
  return {type:'22lr', cost:3, hit:0.75, min:20, max:30};
}
function updateFireLabel () {
  if(!state.ammo || !state.ownedWeapons.has(state.ammo)){
    el.btnFire.textContent = "ğŸ”« ê²©ë°œ (ë¬´ê¸° ì—†ìŒ)";
    el.btnFire.disabled = true;
  }else{
    const st=fireStats();
    const label = st.type==='taser' ? "ë°°í„°ë¦¬" : (st.type==='shotgun'?'ë²…ìƒ·':st.type);
    el.btnFire.textContent = `ğŸ”« ê²©ë°œ (${label} ${st.cost}ğŸ’°)`;
    el.btnFire.disabled = false;
  }
}

// ---------- UI ë¼ë””ì˜¤ ----------
function setupRadioGroup(container, selector, onSelect){
  const btns = Array.from(container.querySelectorAll(selector));
  btns.forEach(b=>{
    b.addEventListener('click', ()=>{
      btns.forEach(x=>x.classList.remove('selected'));
      b.classList.add('selected');
      onSelect(b);
    });
  });
}
setupRadioGroup(el.grpOrg,'button',b=>state.org=b.dataset.org);
setupRadioGroup(el.grpGender,'button',b=>state.gender=b.dataset.g);
setupRadioGroup(el.grpRank,'button',b=>state.startRankIdx=parseInt(b.dataset.rank||'1'));

function paintOrgBadge(){
  el.orgBadge.classList.remove('police','coast');
  el.orgBadge.classList.add(state.org==='coast'?'coast':'police');
  el.orgBadge.textContent = state.org==='coast'?'ğŸš¤ í•´ì–‘ê²½ì°°':'ğŸš“ ê²½ì°°';
}
function updateHUD(){
  paintOrgBadge();
  el.emoji.textContent=emojiByGender();
  el.rank.textContent=RANKS[state.rankIdx];
  el.name.textContent=state.name;
  el.hp.textContent=state.hp;
  el.maxhp.textContent=state.maxHP;
  el.gold.textContent=state.gold;
  el.bags.textContent=state.bags;
  el.enemyName.textContent=state.enemyLabel;
  el.enemyHP.textContent=state.enemyHP;
  el.cost.textContent=state.cost;
  el.buy22.disabled = state.ownedWeapons.has('22lr');
  el.buy9.disabled  = state.ownedWeapons.has('9mm');
  el.buyShot.disabled = state.ownedWeapons.has('shotgun');
  el.buyTaser.disabled= state.ownedWeapons.has('taser');
  el.buy22.textContent = state.ownedWeapons.has('22lr') ? "22lr ê¶Œì´ (êµ¬ë§¤ì™„ë£Œ)" : "22lr ê¶Œì´ (10ğŸ’°)";
  el.buy9.textContent  = state.ownedWeapons.has('9mm') ? "9mm ê¶Œì´ (êµ¬ë§¤ì™„ë£Œ)" : "9mm ê¶Œì´ (20ğŸ’°)";
  el.buyShot.textContent = state.ownedWeapons.has('shotgun') ? "ì—½ì´ (êµ¬ë§¤ì™„ë£Œ)" : "ì—½ì´ (35ğŸ’°)";
  el.buyTaser.textContent= state.ownedWeapons.has('taser') ? "í…Œì´ì €ê±´ (êµ¬ë§¤ì™„ë£Œ)" : "í…Œì´ì €ê±´ (50ğŸ’°)";
  updateFireLabel();
}
let popCanClose=false;
const openPopup=(title,lines)=>{
  popCanClose=false;
  el.popTitle.textContent=title;
  el.popList.innerHTML=(Array.isArray(lines)?lines:[lines]).map(x=>`<li>${x}</li>`).join("");
  el.pop.style.display="flex";
  setTimeout(()=>{ popCanClose=true; }, 1000); // 1ì´ˆ í›„ ë‹«ê¸° ê°€ëŠ¥
};
const closePopup=()=>{ if(!popCanClose) return; el.pop.style.display="none"; };
el.popOk.onclick=closePopup; el.pop.onclick=e=>{ if(e.target===el.pop) closePopup(); };

// ---------- ìŠ¹ì§„ ê·œì¹™ ----------
function tryPromoteRollRequirement(idx){
  if(idx===0) return 6;
  if(idx>=1 && idx<=3) return 7;
  if(idx>=4 && idx<=6) return 8;
  if(idx>=7 && idx<=9) return 9;
  if(idx===10) return 10;
  return 12;
}
function minMonthsForNext(idx){
  if (idx === 0) return 36;
  if (idx >= 1 && idx <= 4) return 12;
  if (idx >= 5 && idx <= 6) return 24;
  if (idx >= 7 && idx <= 10) return 12;
  if (idx === 11) return 12;
  return 0;
}
function costForRank(idx){
  if(idx===0) return 7;
  const steps = idx-1;
  return Math.ceil(10 * (1.3 ** steps));
}

// ---------- ë³´ìƒ ----------
function baseGoldByTier(t){ return t===1?2: t===2?4: t===3?8: t===4?16: t===5?32: 64; }
function currentExpectedGold(){
  const tier = enemyTier(state.level);
  const base = baseGoldByTier(tier);
  const bonus = state.rankIdx>0? state.rankIdx : 0;
  return base + bonus;
}

// ---------- ì  íŠ¹ìˆ˜íš¨ê³¼ ----------
function tierEffects(tier){
  switch(tier){
    case 1: return { extraDmgChance: 0.00, defReduceChance: 0.00, tip:"ê¸°ë³¸ ì " };
    case 2: return { extraDmgChance: 0.25, defReduceChance: 0.00, tip:"25% í™•ë¥  ì¶”ê°€ ë°ë¯¸ì§€" };
    case 3: return { extraDmgChance: 0.25, defReduceChance: 0.25, tip:"25% ì¶”ê°€ ë°ë¯¸ì§€ / 25% ë°©ì–´ -1" };
    case 4: return { extraDmgChance: 0.50, defReduceChance: 0.25, tip:"50% ì¶”ê°€ ë°ë¯¸ì§€ / 25% ë°©ì–´ -1" };
    case 5: return { extraDmgChance: 0.50, defReduceChance: 0.50, tip:"50% ì¶”ê°€ ë°ë¯¸ì§€ / 50% ë°©ì–´ -1" };
    case 6: return { extraDmgChance: 1.00, defReduceChance: 1.00, tip:"ë§¤í„´ ì¶”ê°€ ë°ë¯¸ì§€ / ë°©ì–´ -1" };
    default:return { extraDmgChance: 0.00, defReduceChance: 0.00, tip:"" };
  }
}
function applyTierModifiers({rawPlayerHit, rawEnemyHit, tier}){
  const eff = tierEffects(tier);
  let playerToEnemy = rawPlayerHit;
  if(Math.random() < eff.defReduceChance){ playerToEnemy = Math.max(0, playerToEnemy - 1); }
  let enemyToPlayer = rawEnemyHit;
  if(Math.random() < eff.extraDmgChance){ enemyToPlayer = enemyToPlayer + 1; }
  return { playerToEnemy, enemyToPlayer };
}

// ---------- ì /ì „íˆ¬ ----------
function pickEnemy(){
  const t=enemyTier(state.level); const list=ENEMIES[t];
  const name=list[rint(0,list.length-1)];
  state.enemyLabel=`Lv.${state.level} ${name}`;
  state.enemyHP=9+state.level*1;
}
function announceTierChange(tier){
  const sample = ENEMIES[tier][0] || "ğŸ‘¤ ì ";
  const tip = tierEffects(tier).tip;
  openPopup("âš ï¸ ì  ë­í¬ ìƒìŠ¹", [
    `í˜„ì¬ ì  í‹°ì–´: ${tier} (${sample})`,
    `íš¨ê³¼: ${tip}`,
    "ì ì´ ë” ê°•í•´ì§€ê³  ë³´ìƒì€ ì»¤ì§‘ë‹ˆë‹¤."
  ]);
  setTimeout(()=>{ el.pop.style.display="none"; }, 3000);
}
function spawnEnemy(){
  el.after.style.display="none";
  // ì „íˆ¬ìš© êµ¬ê¸‰í•¨ ë²„íŠ¼ ë³µì›
  el.btnUseBag.style.display = "inline-block";
  // í„´ í”Œë˜ê·¸ ì´ˆê¸°í™”
  state.turn = { fireMsg:null, excessive:null, reward:null };
  state.doubleJustBonus = false;

  pickEnemy(); updateHUD();
  el.msg.textContent="âš”ï¸ ì œì•• ì¤‘...";
  el.pDice.textContent="ğŸ²"; el.eDice.textContent="ğŸ²";
  el.btnRoll.disabled=false; el.btnFire.disabled=false; el.btnUseBag.disabled=false; el.btnBaton.disabled=false;

  const t = enemyTier(state.level);
  if(state.lastTier===null) state.lastTier=t;
  if(state.lastTier!==t){ announceTierChange(t); state.lastTier=t; }
}
function grantGold(){ let earn=currentExpectedGold(); state.gold+=earn; updateHUD(); return earn; }

// ---------- ì´ë ¥ ----------
function logRankChange(kind, prevIdx, nowIdx){
  const prev=RANKS[prevIdx], now=RANKS[nowIdx];
  const icon=kind.startsWith('ìŠ¹ì§„')?'â¬†ï¸':'â¬‡ï¸';
  const label = nthYearLabel(monthsInRank());
  state.changeLog.push(`${icon} ${prev} â†’ ${now} ${kind} (í•´ë‹¹ ê³„ê¸‰ ${label} ${kind})`);
}

// ---------- ì• í”„í„° íŒ¨ë„ ì •ë³´ ----------
function monthsToNextEligibleAnniv(){
  const m = monthsInRank();
  const need = minMonthsForNext(state.rankIdx);
  const target = Math.ceil(Math.max(m+1, need)/12)*12;
  return Math.max(0, target - m);
}
function monthsToLongService(){
  const idx=state.rankIdx; const m=monthsInRank();
  let need=null;
  if(idx===0) need=36;
  else if(idx===1) need=48;
  else if(idx===2) need=60;
  else if(idx===3) need=78;
  else if(idx===4) need=96;
  if(need==null) return null;
  return Math.max(0, need - m);
}
function updateAfterInfo(){
  const mp = monthsToNextEligibleAnniv();
  const pBattles = Math.max(0, Math.ceil(mp/4));
  const ml = monthsToLongService();
  const lBattles = (ml==null) ? null : Math.max(0, Math.ceil(ml/4));
  let line = `ğŸ–ï¸ ìŠ¹ì§„ ë„ì „ê¹Œì§€ ${pBattles} ì „íˆ¬(ì• í”„í„°) ë‚¨ìŒ`;
  line += " / ";
  line += (lBattles==null) ? `ê·¼ì† ìŠ¹ì§„ ì—†ìŒ` : `ê·¼ì† ìŠ¹ì§„ê¹Œì§€ ${lBattles} ì „íˆ¬ ë‚¨ìŒ`;
  el.afterInfo.textContent = line;
}

// ---------- ì• í”„í„° íŒ¨ë„ì—ì„œë§Œ +4ê°œì›” ----------
function showAfterPanelThenAccrue(){
  el.after.style.display="block";
  // ì „íˆ¬ìš© êµ¬ê¸‰í•¨ ë²„íŠ¼ì€ ì• í”„í„° ë™ì•ˆ ìˆ¨ê¹€
  el.btnUseBag.style.display = "none";

  state.monthsAccum += 4;
  checkLongServicePromotion();
  checkRetirement();
  updatePromotionAvailability();
  updateAfterInfo();
}

// ---------- ì „íˆ¬ ê³µí†µ ----------
function canAct(){ return state.enemyHP>0 && !state.ended && el.after.style.display==="none"; }
function rollAnim(p,e){
  el.pDice.classList.add("shake"); el.eDice.classList.add("shake");
  setTimeout(()=>{ el.pDice.classList.remove("shake"); el.eDice.classList.remove("shake"); el.pDice.textContent=DICE[p-1]; el.eDice.textContent=DICE[e-1]; },300);
}

// ì—°ì† ë”ë¸” ë³´ë„ˆìŠ¤ ê°ì§€ â†’ íì— í‘œì‹œë˜ë„ë¡ í”Œë˜ê·¸ë§Œ ì„¸íŒ…
function applyDoubleStreak(p,e){
  if(p===e){
    state.doubleStreak += 1;
    if(state.doubleStreak>=2){
      state.gold += 10; updateHUD();
      state.doubleJustBonus = true;
    }
  }else{
    state.doubleStreak = 0;
  }
}

// ê¸°ë³¸ ì£¼ì‚¬ìœ„ ì „íˆ¬
el.btnRoll.onclick=()=>{
  if(!canAct()) return;
  el.btnRoll.disabled=true; el.btnFire.disabled=true; el.btnUseBag.disabled=true; el.btnBaton.disabled=true;

  const p=rint(1,6), e=rint(1,6);
  rollAnim(p,e);
  setTimeout(()=>{
    applyDoubleStreak(p,e);
    const tier = enemyTier(state.level);
    const mod  = applyTierModifiers({ rawPlayerHit:p, rawEnemyHit:e, tier });

    state.enemyHP -= mod.playerToEnemy;
    state.hp      -= mod.enemyToPlayer;
    updateHUD();

    if(state.enemyHP<=0){ if(state.hp<=0){ onDeath(); return; } handleVictory(); return; }
    if(state.hp<=0){ onDeath(); return; }

    el.msg.textContent="âš”ï¸ ì œì•• ì¤‘...";
    el.btnRoll.disabled=false; el.btnFire.disabled=false; el.btnUseBag.disabled=false; el.btnBaton.disabled=false;
  },300);
};

// ì‚¼ë‹¨ë´‰
el.btnBaton.onclick=()=>{
  if(!canAct()) return;
  if(state.gold < 1){ el.msg.textContent="ğŸ’° ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!"; return; }
  el.btnRoll.disabled=true; el.btnFire.disabled=true; el.btnUseBag.disabled=true; el.btnBaton.disabled=true;

  const p=rint(1,6), e=rint(1,6);
  rollAnim(p,e);
  setTimeout(()=>{
    state.gold -= 1;
    state.batonUses += 1;
    const tier = enemyTier(state.level);
    const rawPlayer = p*2;
    const mod  = applyTierModifiers({ rawPlayerHit:rawPlayer, rawEnemyHit:e, tier });

    state.enemyHP -= mod.playerToEnemy;
    state.hp      -= mod.enemyToPlayer;
    updateHUD();

    if(state.enemyHP<=0){ if(state.hp<=0){ onDeath(); return; } handleVictory(); return; }
    if(state.hp<=0){ onDeath(); return; }

    el.msg.textContent="âš”ï¸ ì œì•• ì¤‘...";
    el.btnRoll.disabled=false; el.btnFire.disabled=false; el.btnUseBag.disabled=false; el.btnBaton.disabled=false;
  },300);
};

// ê²©ë°œ
function enemyCounterThenResume(){
  const e=rint(1,6); el.pDice.textContent="â›”"; el.eDice.textContent=DICE[e-1];
  setTimeout(()=>{ 
    const tier = enemyTier(state.level);
    const mod  = applyTierModifiers({ rawPlayerHit:0, rawEnemyHit:e, tier });
    state.hp -= mod.enemyToPlayer;
    updateHUD(); if(state.hp<=0){ onDeath(); return; }
    el.msg.textContent="ì ì˜ ë°˜ê²©!";
    el.btnRoll.disabled=false; el.btnFire.disabled=false; el.btnUseBag.disabled=false; el.btnBaton.disabled=false;
  },800);
}
el.btnFire.onclick=()=>{
  if(!canAct()) return;
  if(!state.ammo || !state.ownedWeapons.has(state.ammo)){ el.msg.textContent="ğŸ”’ ë¬´ê¸°ë¥¼ ë¨¼ì € êµ¬ë§¤í•˜ì„¸ìš”!"; return; }
  const st = fireStats();
  if(state.gold < st.cost){ el.msg.textContent="ğŸ’° ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!"; return; }
  state.gold-=st.cost; updateHUD();

  // ì„¬ê´‘
  flashMuzzle();

  el.btnRoll.disabled=true; el.btnFire.disabled=true; el.btnUseBag.disabled=true; el.btnBaton.disabled=true;

  if(st.type==='taser'){
    const success = Math.random() < st.hit;
    state.turn.fireMsg = success ? "âš¡ í…Œì´ì € ì ì¤‘! ì¦‰ì‹œ ì œì••" : "âš¡ í…Œì´ì € ì‹¤íŒ¨!";
    setTimeout(()=>{
      if(success){
        state.enemyHP = 0; updateHUD();
        if(state.hp<=0){ onDeath(); return; }
        handleVictory(); return;
      }else{
        enemyCounterThenResume();
      }
    },800);
    return;
  }

  const ok=Math.random()<st.hit;
  if(ok){
    const raw=rint(st.min,st.max);
    const tier = enemyTier(state.level);
    const mod  = applyTierModifiers({ rawPlayerHit:raw, rawEnemyHit:0, tier });
    const dmg  = mod.playerToEnemy;
    state.turn.fireMsg = `ğŸ¯ ì ì¤‘! (-${dmg})`;
    setTimeout(()=>{ 
      state.enemyHP-=dmg; updateHUD();
      if(state.enemyHP<=0){ if(state.hp<=0){ onDeath(); return; } handleVictory(); return; }
      enemyCounterThenResume();
    },800);
  }else{
    state.turn.fireMsg = "âŒ ì‹¤íŒ¨!";
    setTimeout(()=> enemyCounterThenResume(), 800);
  }
};

// ì „íˆ¬ ì¤‘ êµ¬ê¸‰í•¨
el.btnUseBag.onclick=()=>{
  if(!canAct()) return;
  if(state.hp>=state.maxHP){ el.msg.textContent="â¤ï¸ ì²´ë ¥ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤."; return; }
  if(state.bags>0){
    state.bags-=1; state.kitUses += 1;
    state.hp=Math.min(state.maxHP,state.hp+30); updateHUD();
    el.btnRoll.disabled=true; el.btnFire.disabled=true; el.btnUseBag.disabled=true; el.btnBaton.disabled=true;
    const e=rint(1,6); el.pDice.textContent="â›”"; el.eDice.textContent=DICE[e-1];
    setTimeout(()=>{ 
      const tier=enemyTier(state.level);
      const mod = applyTierModifiers({ rawPlayerHit:0, rawEnemyHit:e, tier });
      state.hp -= mod.enemyToPlayer;
      updateHUD(); if(state.hp<=0){ onDeath(); return; }
      el.msg.textContent="ì ì˜ ë°˜ê²©!"; el.btnRoll.disabled=false; el.btnFire.disabled=false; el.btnUseBag.disabled=false; el.btnBaton.disabled=false;
    },800);
  } else { el.msg.textContent="ğŸ’‰ êµ¬ê¸‰í•¨ì´ ì—†ìŠµë‹ˆë‹¤!"; }
};

// ìŠ¹ë¦¬ ì²˜ë¦¬ (í† ìŠ¤íŠ¸ ìˆœì°¨ í‘œì‹œ)
function handleVictory(){
  const q=[]; // ìˆœì°¨ í† ìŠ¤íŠ¸
  if(state.doubleJustBonus) q.push("ğŸ‰ ì—°ì† ë”ë¸” 2íšŒ! +10ê³¨ë“œ");

  const pure=state.enemyLabel.replace(/Lv\.[0-9]+\s*/,'');
  state.defeated[pure]=(state.defeated[pure]||0)+1;

  // ê³¼ì‰ì§„ì•• ë° ë³´ìƒ íŒë‹¨
  let endText="";
  if(state.enemyHP<=-15){
    // ê°•ë“±
    if(state.rankIdx===0){ openEnding("íŒŒë©´"); return; }
    const prevIdx=state.rankIdx;
    state.rankIdx-=1; state.demotionCount += 1;
    state.cost = costForRank(state.rankIdx);
    state.maxHP=Math.max(10,state.maxHP-10);
    state.hp=Math.min(state.hp,state.maxHP);
    logRankChange("ê°•ë“±", prevIdx, state.rankIdx);
    updateHUD();
    endText="ì  ì‚¬ë§, ê°•ë“±!";
    q.push("âš ï¸ ê³¼ì‰ì§„ì••ìœ¼ë¡œ ê°•ë“±");
    if(state.demotionCount>=3){ openEnding("íŒŒë©´"); return; }
  }else if(state.enemyHP<=-10){
    endText="ê³¼ì‰ì§„ì•• ë³´ìƒì—†ìŒ";
    q.push("âš ï¸ ê³¼ì‰ì§„ì••: ë³´ìƒ ì—†ìŒ");
  }else{
    const earned=grantGold();
    endText=`ì ì„ ì œì••í–ˆë‹¤! +${earned} ê³¨ë“œ`;
    q.push(`ğŸ’° ë³´ìƒ +${earned} ê³¨ë“œ`);
  }

  // ê²©ë°œ ë©”ì‹œì§€(ìˆë‹¤ë©´) 2ë²ˆ ìˆœì„œë¡œ ë„£ê¸°
  if(state.turn.fireMsg){
    // ìˆœì„œ: (1) ë”ë¸” â†’ (2) ê²©ë°œ â†’ (3) ê³¼ì‰ â†’ (4) ë³´ìƒ
    // ì§€ê¸ˆ qì—ëŠ” (1)ê³¼ (3)/(4)ê°€ ìˆìœ¼ë‹ˆ, ê²©ë°œì„ ë§¨ ì• ë˜ëŠ” ë‘ë²ˆì§¸ ìœ„ì¹˜ë¡œ ì‚½ì…
    const first = (state.doubleJustBonus?1:0);
    q.splice(first, 0, state.turn.fireMsg);
  }

  // ìˆœì°¨ í† ìŠ¤íŠ¸ ì‹¤í–‰
  q.forEach(m=>pushToast(m,2000));

  el.msg.textContent=endText;
  showAfterPanelThenAccrue();
  state.level += 1; if(state.level>MAX_LEVEL) openEnding("ê³„ê¸‰ì •ë…„í‡´ì§");
}

// ---------- ìŠ¹ì§„ ----------
function monthsUntilNextAnniv(){ const m = monthsInRank(); const rem = m % 12; return rem === 0 ? 12 : (12 - rem); }
function updatePromotionAvailability(){
  const mir=monthsInRank();
  const isAnniv=(mir>0)&&(mir%12===0);
  const needMonths=minMonthsForNext(state.rankIdx);
  const allow=isAnniv&&(mir>=needMonths)&&(state.rankIdx < RANKS.length-1);
  el.btnPromote.disabled=!allow; el.btnPromote.style.opacity=allow?1:.6;
  const needY = Math.floor(needMonths/12);
  const nextIn = isAnniv ? (mir>=needMonths?0:12) : monthsUntilNextAnniv();
  const tipParts = [];
  tipParts.push(`ë„ì „ ìµœì†Œì—°ì°¨: ${needY}ë…„ì°¨${needMonths%12?` ${needMonths%12}ê°œì›”`:''}`);
  tipParts.push(allow?`ì§€ê¸ˆ ë„ì „ ê°€ëŠ¥`:`ë‹¤ìŒ ë„ì „ê¹Œì§€ ì•½ ${nextIn}ê°œì›”`);
  el.btnPromote.title = tipParts.join(" | ");
  if(allow && state.lastPromoAnnivNotifiedAt!==mir){
    openPopup("ìŠ¹ì§„ì‹œê¸° ë„ë˜", `í˜„ ê³„ê¸‰ì—ì„œ ${nthYearLabel(mir)}ì— ìŠ¹ì§„ ë„ì „ì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
    setTimeout(()=>{ el.pop.style.display="none"; }, 3000);
    state.lastPromoAnnivNotifiedAt = mir;
  }
}
function openPromo(onRoll){
  $("promoD1").textContent="ğŸ²"; $("promoD2").textContent="ğŸ²";
  $("promo").style.display="flex";
  const lock=(yes)=>{ el.promoGo.disabled=yes; el.promoCancel.disabled=yes; el.promoGo.style.visibility=yes?'hidden':'visible'; el.promoCancel.style.visibility=yes?'hidden':'visible'; };
  const doRoll=()=>{
    const a=rint(1,6), b=rint(1,6);
    el.promoD1.classList.add("promoShake"); el.promoD2.classList.add("promoShake");
    setTimeout(()=>{
      el.promoD1.classList.remove("promoShake"); el.promoD2.classList.remove("promoShake");
      el.promoD1.textContent=DICE[a-1]; el.promoD2.textContent=DICE[b-1];
      onRoll(a,b);
      setTimeout(()=>{ $("promo").style.display="none"; lock(false); }, 2000);
    },500);
  };
  el.promoGo.onclick=()=>{ lock(true); doRoll(); };
  el.promoCancel.onclick=()=>{ if(el.promoGo.disabled) return; $("promo").style.display="none"; };
}
el.btnPromote.onclick=()=>{
  if(state.ended) return;
  const mir=monthsInRank(); const isAnniv=(mir>0)&&(mir%12===0); const needMonths=minMonthsForNext(state.rankIdx);
  if(!isAnniv || mir<needMonths){ openPopup("â³ ìŠ¹ì§„ë„ì „ ë¶ˆê°€", "ì—°ì°¨(ë§Œ 1Â·2Â·3ë…„â€¦ / ê²½ê°Â·ê²½ì •ì€ 2ë…„ì°¨) ë„ë‹¬ ì‹œ ë„ì „ ê°€ëŠ¥í•©ë‹ˆë‹¤."); setTimeout(()=>{ el.pop.style.display="none"; }, 3000); return; }

  if(state.rankIdx===11){
    if(state.gold < state.cost){ openPopup("ğŸ’° ê³¨ë“œ ë¶€ì¡±", [`ì—”ë”© ì¡°ê±´ ë¹„ìš© ${state.cost}ğŸ’°ì´ í•„ìš”í•©ë‹ˆë‹¤.`]); setTimeout(()=>{ el.pop.style.display="none"; }, 3000); return; }
    state.gold -= state.cost; updateHUD();
    const pool = (state.org==='coast')
      ? ['ğŸŒŠ í‡´ì§ í›„ í•´ì–‘ìˆ˜ì‚°ë¶€ ì¥ê´€ì´ ë˜ì—ˆë‹¤.','ğŸ›ï¸ í‡´ì§ í›„ êµ­íšŒì˜ì›ì´ ë˜ì—ˆë‹¤.','ğŸ“ í‡´ì§ í›„ ëŒ€í•™ êµìˆ˜ê°€ ë˜ì—ˆë‹¤.']
      : ['ğŸ¢ í‡´ì§ í›„ í–‰ì •ì•ˆì „ë¶€ ì¥ê´€ì´ ë˜ì—ˆë‹¤.','ğŸ›ï¸ í‡´ì§ í›„ êµ­íšŒì˜ì›ì´ ë˜ì—ˆë‹¤.','ğŸ“ í‡´ì§ í›„ ëŒ€í•™ êµìˆ˜ê°€ ë˜ì—ˆë‹¤.'];
    state.specialPostCareer = pool[rint(0,pool.length-1)];
    openEnding("ëª…ì˜ˆí‡´ì§");
    return;
  }

  if(state.gold < state.cost){ openPopup("ğŸ’° ê³¨ë“œ ë¶€ì¡±", [`ìŠ¹ì§„ë„ì „ ë¹„ìš© ${state.cost}ğŸ’°ì´ í•„ìš”í•©ë‹ˆë‹¤.`]); setTimeout(()=>{ el.pop.style.display="none"; }, 3000); return; }
  const req = tryPromoteRollRequirement(state.rankIdx);
  openPromo((a,b)=>{
    const sum=a+b;
    if(state.gold < state.cost){ openPopup("ğŸ’° ê³¨ë“œ ë¶€ì¡±", [`ìŠ¹ì§„ë„ì „ ë¹„ìš© ${state.cost}ğŸ’°ì´ í•„ìš”í•©ë‹ˆë‹¤.`]); setTimeout(()=>{ el.pop.style.display="none"; }, 3000); return; }
    state.gold -= state.cost; updateHUD();
    if(sum>=req){ doPromote("ìŠ¹ì§„"); openPopup("âœ… ìŠ¹ì§„ ì„±ê³µ", [`í•„ìš”${req}ì , ë‹¹ì‹ ì˜ ì ìˆ˜ ${sum}ì  ì„±ê³µ`, "í˜œíƒ: ìµœëŒ€ì²´ë ¥ +10"]); pushToast("ğŸ–ï¸ ìŠ¹ì§„ ì„±ê³µ! ìµœëŒ€ì²´ë ¥ +10",2000); }
    else{ openPopup("âŒ ìŠ¹ì§„ ì‹¤íŒ¨", [`í•„ìš”${req}ì , ë‹¹ì‹ ì˜ ì ìˆ˜ ${sum}ì  ì‹¤íŒ¨`, `ë‹¤ìŒ ë„ì „ ê°€ëŠ¥: ì•½ ${monthsUntilNextAnniv()}ê°œì›” í›„ ì—°ì°¨`]); pushToast("ğŸ² ì‹¤íŒ¨! ë‹¤ìŒ ì—°ì°¨ì— ì¬ë„ì „",2000); }
    setTimeout(()=>{ el.pop.style.display="none"; }, 3000);
    el.btnPromote.disabled=true; updateAfterInfo();
  });
};
function doPromote(kindLabel="ìŠ¹ì§„"){
  const TOP=RANKS.length-1; if(state.rankIdx>=TOP){ openEnding("ëª…ì˜ˆí‡´ì§"); return; }
  const prevIdx=state.rankIdx; state.rankIdx+=1; state.cost=costForRank(state.rankIdx);
  state.maxHP+=10; state.hp=Math.min(state.maxHP,state.hp+99);
  logRankChange(kindLabel, prevIdx, state.rankIdx);
  state.lastRankChangeMonths = state.monthsAccum;
  updateHUD();
}

// ê·¼ì†ìŠ¹ì§„
function checkLongServicePromotion(){
  const idx=state.rankIdx; const m=monthsInRank();
  let need=null;
  if(idx===0) need=36; else if(idx===1) need=48; else if(idx===2) need=60; else if(idx===3) need=78; else if(idx===4) need=96;
  if(need!=null && m>=need){
    const prevIdx=state.rankIdx;
    state.rankIdx+=1; state.cost=costForRank(state.rankIdx);
    state.maxHP+=10; state.hp=Math.min(state.maxHP,state.hp+99);
    logRankChange("ìŠ¹ì§„(ê·¼ì†)", prevIdx, state.rankIdx);
    state.lastRankChangeMonths=state.monthsAccum;
    updateHUD(); openPopup("ğŸ† ê·¼ì†ìŠ¹ì§„", [`ê³„ê¸‰: ${RANKS[prevIdx]} â†’ ${RANKS[state.rankIdx]}`, `ìµœëŒ€ì²´ë ¥ +10`]);
    setTimeout(()=>{ el.pop.style.display="none"; }, 3000);
    pushToast("ğŸ† ê·¼ì†ìŠ¹ì§„! ìµœëŒ€ì²´ë ¥ +10",2000);
  }
}

// ì •ë…„/ê³„ê¸‰ì •ë…„
function checkRetirement(){
  const idx=state.rankIdx; const m=monthsInRank();
  let limit=null;
  if(idx===6) limit=168; else if(idx===7) limit=132; else if(idx===8) limit=72; else if(idx===9) limit=48;
  if(limit!=null && m>=limit){
    openPopup("ğŸ–ï¸ ê³„ê¸‰ì •ë…„í‡´ì§", `í˜„ ê³„ê¸‰ ${RANKS[idx]}ì—ì„œ ${fmtYM(m)} ë™ì•ˆ ìŠ¹ì§„/ê°•ë“±ì´ ì—†ì–´ í‡´ì§í•©ë‹ˆë‹¤.`); 
    setTimeout(()=>{ el.pop.style.display="none"; }, 3000);
    openEnding("ê³„ê¸‰ì •ë…„í‡´ì§");
  }
}

// ì—”ë”© + ì—…ì 
function buildAchievements(endTitle){
  const ach=[];
  const years = Math.floor(state.monthsAccum/12);
  if(years>=30) ach.push("ğŸ… ì¥ê¸°ê·¼ì†(30ë…„+)");
  else if(years>=20) ach.push("ğŸ… ì¥ê¸°ê·¼ì†(20ë…„+)");
  if(state.ownedWeapons.has('22lr')&&state.ownedWeapons.has('9mm')&&state.ownedWeapons.has('shotgun')&&state.ownedWeapons.has('taser')) ach.push("ğŸ”« ë¬´ê¸°ì• í˜¸ê°€");
  if(state.demotionCount>=2) ach.push("ğŸš¨ ê³¼ì‰ì§„ì•• ê²½ì°°ê´€");
  if(state.batonUses>=20) ach.push("ğŸ¦¯ ì‚¼ë‹¨ë´‰ ì• í˜¸ê°€");
  if(state.kitUses>=20) ach.push("ğŸ’‰ ì•½ë¬¼ ì¤‘ë…ì");
  if(endTitle==="ëª…ì˜ˆí‡´ì§" && years<=20) ach.push("âš¡ ì´ˆë‹¨ê¸° ìŠ¹ì§„ì");
  if(endTitle==="ëª…ì˜ˆí‡´ì§" && state.specialPostCareer){ ach.push(`ğŸ‘” ${state.specialPostCareer}`); }
  return ach;
}
function addEndLines(base){
  const startStr=new Date(state.startDate).toLocaleDateString('ko-KR',{year:'numeric',month:'long',day:'numeric'});
  base.push(`ğŸ‘¤ ì´ë¦„ : ${state.name}`);
  base.push(`ì„ìš© : ${startStr} ${orgName()} ${state.entryRank}`);
  base.push(`í˜„ì¬ ê³„ê¸‰ : ${RANKS[state.rankIdx]} (í˜„ì¬ê³„ê¸‰ ${nthYearLabel(state.monthsAccum)})`);
  base.push(`ê·¼ë¬´ê¸°ê°„ : ${fmtYM(state.monthsAccum)}`);
  base.push(`ë§ˆì§€ë§‰ ë³´ìœ  ê³¨ë“œ : ${state.gold||0}`);
}
function saveMemorial(endTitle, achievements){
  try{
    const entry={ id:Date.now(), endTitle, name:state.name, org:orgName(),
      entryRank:state.entryRank, currentRank:RANKS[state.rankIdx], startDate:state.startDate,
      months:state.monthsAccum, level:state.level, defeated:state.defeated, changeLog:state.changeLog, finalGold:state.gold||0,
      achievements, gender: state.gender };
    const arr=JSON.parse(localStorage.getItem("police_memorials")||"[]"); arr.push(entry);
    localStorage.setItem("police_memorials", JSON.stringify(arr));
  }catch(e){}
}
function openEnding(title){
  state.ended=true;
  el.endPlayerName.textContent = state.name;
  const lines=[]; if(title==="ìˆœì§"){ lines.push("ğŸª¦ ìˆœì§ìœ¼ë¡œ ì¸í•œ 1ê³„ê¸‰ íŠ¹ì§„"); }
  addEndLines(lines);
  const achievements = buildAchievements(title);

  el.endTitle.textContent=title + " â€” " + state.name;
  el.endList.innerHTML=lines.map(s=>`<li>${s}</li>`).join("");

  if(achievements.length){
    el.achBlock.style.display="flex";
    el.ach.style.display="block";
    el.ach.innerHTML = achievements.map(s=>`<li>â€¢ ${s}</li>`).join("");
  }else{
    el.achBlock.style.display="none";
    el.ach.style.display="none";
    el.ach.innerHTML = "";
  }

  el.hist.innerHTML = state.changeLog.length? state.changeLog.map(s=>`<li>â€¢ ${s}</li>`).join(""):`<li class="small">ê¸°ë¡ ì—†ìŒ</li>`;
  const ks=Object.keys(state.defeated);
  el.kill.innerHTML = ks.length? ks.map(k=>`<li>${k}: ${state.defeated[k]}ëª…</li>`).join(""):`<li class="small">ê¸°ë¡ ì—†ìŒ</li>`;
  saveMemorial(title, achievements);
  el.ending.style.display="flex";
}
function onDeath(){
  const prevIdx=state.rankIdx;
  if(state.rankIdx < RANKS.length-1){ state.rankIdx += 1; }
  const label = nthYearLabel(monthsInRank());
  state.changeLog.push(`â¬†ï¸ ${RANKS[prevIdx]} â†’ ${RANKS[state.rankIdx]} ìˆœì§ìœ¼ë¡œ ì¸í•œ íŠ¹ì§„ (í•´ë‹¹ ê³„ê¸‰ ${label} ìŠ¹ì§„)`);
  updateHUD(); openEnding("ìˆœì§");
}

// ì¼ë°˜
function applyStartRank(){
  state.rankIdx = (state.startRankIdx===4)?4:1;
  state.entryRank = RANKS[state.rankIdx];
  state.lastRankChangeMonths = 0;
  state.maxHP = (state.rankIdx===4)?80:50;
  state.hp = state.maxHP; state.gold=0; state.bags=0;
  state.cost = costForRank(state.rankIdx);
  state.ownedWeapons = new Set();
  state.ammo = '';
  state.batonUses = 0; state.kitUses = 0; state.demotionCount = 0;
  state.specialPostCareer = null;
  updateHUD();
}
function backToStart(){
  Object.assign(state,{ 
    org:null, gender:null, name:"â€”", startRankIdx:1, rankIdx:1, entryRank:"ìˆœê²½",
    level:1, maxHP:50, hp:50, gold:0, bags:0, enemyHP:0, enemyLabel:"", cost:10,
    ended:false, startDate:new Date(), defeated:{}, changeLog:[], monthsAccum:0,
    ammo:'', ownedWeapons:new Set(), demotionCount:0, lastRankChangeMonths:0,
    lastPromoAnnivNotifiedAt:-1, doubleStreak:0, doubleJustBonus:false, lastTier:null, batonUses:0, kitUses:0, specialPostCareer:null,
    turn:{fireMsg:null, excessive:null, reward:null}
  });
  el.start.style.display="flex"; el.ending.style.display="none"; updateHUD();
}
el.backToStart.onclick=()=>{ backToStart(); };

// ì˜ì›ë©´ì§ (ìì‚°ê°€ ì¡°ê±´: ë³´ìœ ê³¨ë“œ â‰¥ min(500, ìŠ¹ì§„ë¹„ìš©Ã—3))
el.btnResign.onclick=()=>{
  if(state.ended) return;
  if(state.monthsAccum>=360){ openEnding("ì •ë…„í‡´ì§"); return; }
  const wealthy = (state.gold >= Math.min(500, state.cost * 3));
  openEnding(wealthy ? "ì˜ì›ë©´ì§-ìì‚°ê°€" : "ì˜ì›ë©´ì§");
};

// ì• í”„í„° íŒ¨ë„
el.btnRest.onclick=()=>{ if(state.ended) return; state.hp=Math.min(state.maxHP,state.hp+5); updateHUD(); el.after.style.display='none'; spawnEnemy(); };
el.btnBuyBag.onclick=()=>{ if(state.ended) return; if(state.gold>=5){ state.gold-=5; state.bags+=1; updateHUD(); } else { el.msg.textContent="ğŸ’° ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!"; } };
el.btnUseBagAfter.onclick=()=>{ if(state.hp>=state.maxHP){ el.msg.textContent="â¤ï¸ ì²´ë ¥ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤."; return; } if(state.bags>0){ state.bags-=1; state.kitUses += 1; state.hp=Math.min(state.maxHP,state.hp+30); updateHUD(); } else { el.msg.textContent="ğŸ’‰ êµ¬ê¸‰í•¨ì´ ì—†ìŠµë‹ˆë‹¤!"; } };

// ë¬´ê¸° êµ¬ë§¤ (ì¤‘ë³µ ë°©ì§€)
function buyWeapon(code, price){
  if(state.ownedWeapons.has(code)) return;
  if(state.gold < price){ pushToast("ğŸ’° ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!",2000); return; }
  state.gold -= price;
  state.ownedWeapons.add(code);
  if(!state.ammo) state.ammo = code; // ì²« êµ¬ì… ìë™ ì¥ì°©
  updateHUD();
  pushToast(`ğŸ›’ ${weaponName(code)} êµ¬ë§¤ ì™„ë£Œ`,2000);
}
el.buy22.onclick = ()=> buyWeapon('22lr',10);
el.buy9.onclick  = ()=> buyWeapon('9mm',20);
el.buyShot.onclick = ()=> buyWeapon('shotgun',35);
el.buyTaser.onclick= ()=> buyWeapon('taser',50);

// ë¬´ê¸°ë³€í™˜(ë³´ìœ  ë¬´ê¸° ìˆœí™˜)
el.btnSwitchWeapon.onclick=()=>{
  const owned = weaponOrder.filter(w=>state.ownedWeapons.has(w));
  if(owned.length===0){ pushToast("ğŸ”’ êµ¬ë§¤í•œ ë¬´ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.",2000); return; }
  if(!state.ammo || !state.ownedWeapons.has(state.ammo)) state.ammo = owned[0];
  else{
    const idx = owned.indexOf(state.ammo);
    state.ammo = owned[(idx+1)%owned.length];
  }
  updateHUD();
  pushToast(`ğŸ”„ ì¥ì°©: ${weaponName(state.ammo)}`,2000);
};

// ì‹œì‘
el.btnStart.onclick=()=>{ 
  if(!state.org) state.org = Math.random()<0.5?'police':'coast';
  if(!state.gender) state.gender = Math.random()<0.5?'M':'F';
  if(!(state.startRankIdx===1 || state.startRankIdx===4)) state.startRankIdx = 1;
  const nm=el.nm.value.trim();
  state.name = nm ? nm : (state.org==='police' ? (state.gender==='F'?'í¬ìˆœ':'í¬ëŒ') : (state.gender==='F'?'í•´ëˆ„ë¦¬':'í•´ìš°ë¦¬'));
  state.startDate=new Date();
  applyStartRank();
  el.start.style.display="none";
  spawnEnemy(); updateHUD();
  paintOrgBadge();
};

backToStart();

})();
</script>
</body>
</html>
